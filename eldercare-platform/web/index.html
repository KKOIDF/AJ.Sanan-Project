<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ - Eldercare System</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }
    .header h1 {
      margin: 0 0 10px 0;
      color: #2c3e50;
      font-size: 2.5em;
    }
    .status {
      font-size: 1.2em;
      margin: 10px 0;
    }
    .big-btn { 
      font-size: 1.5rem; 
      padding: 15px 30px; 
      margin: 10px; 
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      font-weight: bold;
      min-width: 200px;
    }
    .emergency { background: #e74c3c; }
    .emergency:hover { background: #c0392b; transform: translateY(-2px); }
    .ok-btn { background: #27ae60; }
    .ok-btn:hover { background: #229954; transform: translateY(-2px); }
    .call-btn { background: #f39c12; }
    .call-btn:hover { background: #e67e22; transform: translateY(-2px); }
    
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .card {
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .card h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    .controls {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .controls label {
      font-weight: bold;
      color: #555;
    }
    
    .controls select, .controls input {
      padding: 8px 12px;
      border: 2px solid #bdc3c7;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .controls button {
      padding: 8px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .controls button:hover {
      background: #2980b9;
    }
    
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 10px;
      background: white;
    }
    th, td { 
      padding: 12px 10px; 
      border: 1px solid #ddd; 
      text-align: left; 
      font-size: 14px;
    }
    th { 
      background: #34495e;
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    tr:hover {
      background: #e8f4fd;
    }
    
    .pill { 
      padding: 4px 12px; 
      border-radius: 20px; 
      color: #fff; 
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      display: inline-block;
      min-width: 60px;
    }
    .Low { background: #27ae60; }
    .Medium { background: #f39c12; }
    .High { background: #e74c3c; }
    
    .meta-info {
      background: #ecf0f1;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      color: #555;
      margin-bottom: 10px;
    }
    
    .loading {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
    }
    
    .error {
      background: #ffeaa7;
      color: #e17055;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #3498db;
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .stat-card.green { background: #27ae60; }
    .stat-card.orange { background: #f39c12; }
    .stat-card.red { background: #e74c3c; }
    .dashboard-section2 { margin-top: 20px; }
    .system-status { color: #27ae60; font-weight: bold; }
    
    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .big-btn {
        min-width: auto;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</h1>
      <div class="status">
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö: <span id="system-status" class="system-status">‚úÖ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
        | ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="current-time"></span>
      </div>
      <div>
        <button class="big-btn ok-btn" onclick="sendOkStatus()">‚úÖ ‡∏â‡∏±‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ</button>
        <button class="big-btn call-btn" onclick="callCaregiver()">üìû ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</button>
        <button class="big-btn emergency" onclick="emergency()">üö® ‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô!</button>
      </div>
    </div>

    <div class="dashboard">
      <!-- Risk Analysis Card -->
      <div class="card">
        <h3>üìä ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h3>
        <div class="stats" id="risk-stats">
          <div class="stat-card green">
            <div class="stat-number" id="low-count">-</div>
            <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-number" id="medium-count">-</div>
            <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</div>
          </div>
          <div class="stat-card red">
            <div class="stat-number" id="high-count">-</div>
            <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</div>
          </div>
        </div>
        <div class="controls">
          <label for="risk-method">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:</label>
          <select id="risk-method">
            <option value="quantile">‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏ó‡∏•‡πå</option>
            <option value="fixed">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</option>
          </select>
          <button onclick="loadRiskLevels()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button onclick="exportRiskData()">üíæ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div class="meta-info" id="risk-meta">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <div class="table-container">
          <table id="risk-table">
            <thead>
              <tr>
                <th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞</th>
                <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
                <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Subjects Overview Card -->
      <div class="card">
        <h3>üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
        <div class="controls">
          <label for="subject-filter">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</label>
          <input type="text" id="subject-filter" placeholder="‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠...">
          <button onclick="loadSubjects()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          <button onclick="refreshAllData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div class="stats" id="subject-stats">
          <div class="stat-card">
            <div class="stat-number" id="total-subjects">-</div>
            <div class="stat-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avg-steps">-</div>
            <div class="stat-label">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avg-active">-</div>
            <div class="stat-label">‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
          </div>
        </div>
        <div class="table-container">
          <table id="subjects-table">
            <thead>
              <tr>
                <th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞</th>
                <th>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô</th>
                <th>‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Additional Dashboard Row -->
    <div class="dashboard dashboard-section2">
      <!-- Device Quality Card -->
      <div class="card">
        <h3>üì± ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</h3>
        <div class="controls">
          <button onclick="loadDeviceQuality()">üìä ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô QC</button>
          <button onclick="generateReport()">üìã ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>
        <div class="stats" id="device-stats">
          <div class="stat-card">
            <div class="stat-number" id="total-devices">-</div>
            <div class="stat-label">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="active-devices">-</div>
            <div class="stat-label">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div>
          </div>
        </div>
        <div class="table-container">
          <table id="device-table">
            <thead>
              <tr>
                <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                <th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Alerts & Notifications Card -->
      <div class="card">
        <h3>üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h3>
        <div class="controls">
          <button onclick="loadAlerts()">üîî ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
          <button onclick="testAlert()">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
          <button onclick="clearAlerts()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
        </div>
        <div class="stats">
          <div class="stat-card red">
            <div class="stat-number" id="urgent-alerts">0</div>
            <div class="stat-label">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-number" id="normal-alerts">0</div>
            <div class="stat-label">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
          </div>
        </div>
        <div id="alerts-container">
          <div class="meta-info">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let alertCount = 0;
    
    // Update current time
    function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleString('th-TH');
    }
    
    // Main action functions
    function sendOkStatus() {
      showNotification('‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
      logActivity('‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ"');
    }
    
    function callCaregiver() {
      showNotification('üìû ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•...', 'info');
      logActivity('‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•');
      setTimeout(() => {
        showNotification('‚úÖ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      }, 2000);
    }
    
    function emergency() {
      showNotification('üö® ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå...', 'error');
      logActivity('‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô - ‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå');
      document.getElementById('urgent-alerts').textContent = parseInt(document.getElementById('urgent-alerts').textContent || '0') + 1;
    }
    
    // Risk analysis functions
    async function loadRiskLevels() {
      try {
        document.querySelector('#risk-table tbody').innerHTML = '<tr><td colspan="4" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
        document.getElementById('risk-meta').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
        
        const method = document.getElementById('risk-method').value;
        const response = await fetch(`/api/v1/offline/risk_levels?method=${method}`);
        const data = await response.json();
        
        const tbody = document.querySelector('#risk-table tbody');
        tbody.innerHTML = '';
        
        let lowCount = 0, mediumCount = 0, highCount = 0;
        
        (data.risk_levels || []).slice(0, 100).forEach(row => {
          const level = row.risk_level || '-';
          const tr = document.createElement('tr');
          
          // Count risk levels
          if (level === 'Low') lowCount++;
          else if (level === 'Medium') mediumCount++;
          else if (level === 'High') highCount++;
          
          const actions = level === 'High' ? '‚ö†Ô∏è ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î' : 
                         level === 'Medium' ? 'üìã ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥' : '‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥';
          
          tr.innerHTML = `
            <td><strong>${row.subject_id ?? '-'}</strong></td>
            <td>${(row.independence_index ?? '').toFixed ? row.independence_index.toFixed(3) : row.independence_index}</td>
            <td><span class="pill ${level}">${level}</span></td>
            <td><small>${actions}</small></td>
          `;
          tbody.appendChild(tr);
        });
        
        // Update stats
        document.getElementById('low-count').textContent = lowCount;
        document.getElementById('medium-count').textContent = mediumCount;
        document.getElementById('high-count').textContent = highCount;
        
        // Update meta info
        const meta = data.meta ? 
          `‡∏ß‡∏¥‡∏ò‡∏µ: ${data.meta.method === 'quantile' ? '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏ó‡∏•‡πå' : '‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà'}, ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡πà‡∏≥: ${data.meta.low_threshold?.toFixed(2)}, ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏π‡∏á: ${data.meta.high_threshold?.toFixed(2)}` : 
          '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• meta';
        document.getElementById('risk-meta').textContent = meta;
        
        showNotification('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        
      } catch (error) {
        console.error('Error loading risk levels:', error);
        document.getElementById('risk-meta').innerHTML = '<span class="error">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</span>';
        showNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
      }
    }
    
    // Subjects functions
    async function loadSubjects() {
      try {
        document.querySelector('#subjects-table tbody').innerHTML = '<tr><td colspan="5" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
        
        const response = await fetch('/api/v1/offline/subjects');
        const data = await response.json();
        
        const tbody = document.querySelector('#subjects-table tbody');
        tbody.innerHTML = '';
        
        const filter = document.getElementById('subject-filter').value.toLowerCase();
        let totalSubjects = 0, totalSteps = 0, totalActive = 0, validSteps = 0, validActive = 0;
        
        (data.subjects || []).forEach(row => {
          const subjectId = String(row.subject_id ?? '');
          if (filter && !subjectId.toLowerCase().includes(filter)) return;
          
          totalSubjects++;
          if (row.steps_sum && !isNaN(row.steps_sum)) {
            totalSteps += row.steps_sum;
            validSteps++;
          }
          if (row.active_minutes && !isNaN(row.active_minutes)) {
            totalActive += row.active_minutes;
            validActive++;
          }
          
          const tr = document.createElement('tr');
          const independenceScore = row.independence_index;
          let status = '‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥';
          if (independenceScore < -0.5) status = '‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°';
          else if (independenceScore > 0.5) status = 'üü¢ ‡∏î‡∏µ‡∏°‡∏≤‡∏Å';
          
          tr.innerHTML = `
            <td><strong>${subjectId}</strong></td>
            <td>${independenceScore?.toFixed ? independenceScore.toFixed(3) : independenceScore || '-'}</td>
            <td>${row.steps_sum?.toLocaleString() || '-'}</td>
            <td>${row.active_minutes || '-'}</td>
            <td><small>${status}</small></td>
          `;
          tbody.appendChild(tr);
        });
        
        // Update subject stats
        document.getElementById('total-subjects').textContent = totalSubjects;
        document.getElementById('avg-steps').textContent = validSteps > 0 ? Math.round(totalSteps / validSteps).toLocaleString() : '-';
        document.getElementById('avg-active').textContent = validActive > 0 ? Math.round(totalActive / validActive) : '-';
        
        if (totalSubjects === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>';
        }
        
      } catch (error) {
        console.error('Error loading subjects:', error);
        document.querySelector('#subjects-table tbody').innerHTML = '<tr><td colspan="5" class="error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      }
    }
    
    // Device quality functions
    async function loadDeviceQuality() {
      try {
        document.querySelector('#device-table tbody').innerHTML = '<tr><td colspan="5" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
        
        const response = await fetch('/api/v1/users/1/dashboard');
        const data = await response.json();
        
        const tbody = document.querySelector('#device-table tbody');
        tbody.innerHTML = '';
        
        if (data.qc_summary_rows) {
          let totalDevices = 0, activeDevices = 0;
          
          data.qc_summary_rows.forEach(row => {
            totalDevices++;
            if (row.row_count > 100) activeDevices++; // Consider active if >100 records
            
            const tr = document.createElement('tr');
            const status = row.row_count > 1000 ? 'üü¢ ‡∏î‡∏µ' : row.row_count > 100 ? 'üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : 'üî¥ ‡∏ô‡πâ‡∏≠‡∏¢';
            
            tr.innerHTML = `
              <td><strong>${row.device_id || row.sensor_file || '-'}</strong></td>
              <td>${row.row_count?.toLocaleString() || '-'}</td>
              <td>${row.unique_days || '-'}</td>
              <td>${row.date_range || '-'}</td>
              <td><small>${status}</small></td>
            `;
            tbody.appendChild(tr);
          });
          
          document.getElementById('total-devices').textContent = totalDevices;
          document.getElementById('active-devices').textContent = activeDevices;
        } else {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td></tr>';
        }
        
      } catch (error) {
        console.error('Error loading device quality:', error);
        document.querySelector('#device-table tbody').innerHTML = '<tr><td colspan="5" class="error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      }
    }
    
    // Alert functions
    function loadAlerts() {
      showNotification('üìä ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'info');
      logActivity('‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
    }
    
    function testAlert() {
      showNotification('üß™ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥', 'info');
      document.getElementById('normal-alerts').textContent = parseInt(document.getElementById('normal-alerts').textContent || '0') + 1;
      logActivity('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
    }
    
    function clearAlerts() {
      document.getElementById('urgent-alerts').textContent = '0';
      document.getElementById('normal-alerts').textContent = '0';
      showNotification('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      logActivity('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
    }
    
    // Export functions
    function exportRiskData() {
      showNotification('üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á...', 'info');
      logActivity('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á');
      setTimeout(() => {
        showNotification('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      }, 1500);
    }
    
    function generateReport() {
      showNotification('üìã ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
      logActivity('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      setTimeout(() => {
        showNotification('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      }, 2000);
    }
    
    function refreshAllData() {
      showNotification('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', 'info');
      loadRiskLevels();
      loadSubjects();
      loadDeviceQuality();
      logActivity('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    }
    
    // Utility functions
    function showNotification(message, type) {
      const alertsContainer = document.getElementById('alerts-container');
      const alertDiv = document.createElement('div');
      alertDiv.className = `meta-info ${type === 'error' ? 'error' : ''}`;
      alertDiv.style.marginBottom = '10px';
      alertDiv.innerHTML = `${message} <small>(${new Date().toLocaleTimeString('th-TH')})</small>`;
      
      alertsContainer.insertBefore(alertDiv, alertsContainer.firstChild);
      
      // Remove old notifications (keep only last 5)
      while (alertsContainer.children.length > 5) {
        alertsContainer.removeChild(alertsContainer.lastChild);
      }
      
      // Auto remove after 10 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.parentNode.removeChild(alertDiv);
        }
      }, 10000);
    }
    
    function logActivity(activity) {
      console.log(`[${new Date().toISOString()}] ${activity}`);
    }
    
    // Initialize page
    function initializePage() {
      updateTime();
      setInterval(updateTime, 1000);
      
      // Load initial data
      loadRiskLevels();
      loadSubjects();
      loadDeviceQuality();
      
      // Show welcome message
      setTimeout(() => {
        showNotification('üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
      }, 500);
      
      console.log('Eldercare System initialized successfully');
    }
    
    // Start the application
    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
