<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ - Eldercare System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans Thai', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .risk-low { background: #10b981; }
        .risk-medium { background: #f59e0b; }
        .risk-high { background: #ef4444; }
        
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Main App Component
        function App() {
            const [data, setData] = useState({
                subjects: [],
                riskLevels: [],
                deviceQuality: [],
                loading: true,
                currentTime: new Date()
            });
            
            const [notifications, setNotifications] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');

            // Fetch data from API
            const fetchData = async () => {
                try {
                    const [subjectsRes, riskRes, deviceRes] = await Promise.all([
                        fetch('/api/subjects?limit=50'),
                        fetch('/api/risk-levels?method=quantile'),
                        fetch('/api/device-quality')
                    ]);

                    const subjects = await subjectsRes.json();
                    const riskLevels = await riskRes.json();
                    const deviceQuality = await deviceRes.json();

                    setData(prev => ({
                        ...prev,
                        subjects: subjects.subjects || [],
                        riskLevels: riskLevels.risk_levels || [],
                        riskCounts: riskLevels.counts || {},
                        riskMeta: riskLevels.meta || {},
                        deviceQuality: deviceQuality.devices || [],
                        deviceSummary: deviceQuality.summary || {},
                        loading: false
                    }));

                    addNotification('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } catch (error) {
                    console.error('Error fetching data:', error);
                    addNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    setData(prev => ({ ...prev, loading: false }));
                }
            };

            // Add notification
            const addNotification = (message, type) => {
                const id = Date.now();
                const notification = { id, message, type, timestamp: new Date() };
                setNotifications(prev => [notification, ...prev.slice(0, 4)]);
                
                setTimeout(() => {
                    setNotifications(prev => prev.filter(n => n.id !== id));
                }, 5000);
            };

            // Emergency actions
            const handleEmergency = () => {
                addNotification('üö® ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå...', 'error');
            };

            const handleOkStatus = () => {
                addNotification('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            };

            const handleCallCaregiver = () => {
                addNotification('üìû ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•...', 'info');
                setTimeout(() => {
                    addNotification('‚úÖ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                }, 2000);
            };

            // Update time every second
            useEffect(() => {
                fetchData();
                const timeInterval = setInterval(() => {
                    setData(prev => ({ ...prev, currentTime: new Date() }));
                }, 1000);

                return () => clearInterval(timeInterval);
            }, []);

            // Filter subjects based on search
            const filteredSubjects = data.subjects.filter(subject =>
                searchTerm === '' || 
                subject.subject_id?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="min-h-screen p-4">
                    {/* Header */}
                    <div className="card-glass rounded-2xl p-6 mb-6 shadow-xl">
                        <div className="text-center">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">
                                üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏
                            </h1>
                            <p className="text-gray-600 mb-4">
                                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö: <span className="text-green-600 font-semibold">‚úÖ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
                                <span className="ml-4">
                                    ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: {data.currentTime.toLocaleString('th-TH')}
                                </span>
                            </p>
                            
                            {/* Main Action Buttons */}
                            <div className="flex flex-wrap justify-center gap-4">
                                <button 
                                    onClick={handleOkStatus}
                                    className="btn-primary text-white px-8 py-4 rounded-full text-lg font-semibold hover:scale-105 transition-transform"
                                >
                                    ‚úÖ ‡∏â‡∏±‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ
                                </button>
                                <button 
                                    onClick={handleCallCaregiver}
                                    className="bg-orange-500 hover:bg-orange-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:scale-105 transition-transform"
                                >
                                    üìû ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                                </button>
                                <button 
                                    onClick={handleEmergency}
                                    className="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:scale-105 transition-transform animate-pulse"
                                >
                                    üö® ‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô!
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Dashboard Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        {/* Risk Analysis Card */}
                        <div className="card-glass rounded-2xl p-6 shadow-xl">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">üìä ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h2>
                            
                            {/* Risk Stats */}
                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <div className="risk-low text-white p-4 rounded-lg text-center">
                                    <div className="text-2xl font-bold">{data.riskCounts?.Low || 0}</div>
                                    <div className="text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥</div>
                                </div>
                                <div className="risk-medium text-white p-4 rounded-lg text-center">
                                    <div className="text-2xl font-bold">{data.riskCounts?.Medium || 0}</div>
                                    <div className="text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</div>
                                </div>
                                <div className="risk-high text-white p-4 rounded-lg text-center">
                                    <div className="text-2xl font-bold">{data.riskCounts?.High || 0}</div>
                                    <div className="text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</div>
                                </div>
                            </div>

                            {/* Risk Table */}
                            <div className="max-h-64 overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th className="p-2 text-left">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                                            <th className="p-2 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                                            <th className="p-2 text-center">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.riskLevels.slice(0, 10).map((item, index) => (
                                            <tr key={index} className="border-b hover:bg-gray-50">
                                                <td className="p-2 font-semibold">{item.subject_id}</td>
                                                <td className="p-2 text-center">{parseFloat(item.independence_index).toFixed(2)}</td>
                                                <td className="p-2 text-center">
                                                    <span className={`px-3 py-1 rounded-full text-white text-xs font-semibold
                                                        ${item.risk_level === 'Low' ? 'risk-low' : 
                                                          item.risk_level === 'Medium' ? 'risk-medium' : 'risk-high'}`}>
                                                        {item.risk_level === 'Low' ? '‡∏ï‡πà‡∏≥' : 
                                                         item.risk_level === 'Medium' ? '‡∏Å‡∏•‡∏≤‡∏á' : '‡∏™‡∏π‡∏á'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Subjects Card */}
                        <div className="card-glass rounded-2xl p-6 shadow-xl">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                            
                            {/* Search */}
                            <div className="mb-4">
                                <input 
                                    type="text"
                                    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..."
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>

                            {/* Subjects Table */}
                            <div className="max-h-64 overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th className="p-2 text-left">‡∏£‡∏´‡∏±‡∏™</th>
                                            <th className="p-2 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞</th>
                                            <th className="p-2 text-center">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredSubjects.slice(0, 15).map((subject, index) => (
                                            <tr key={index} className="border-b hover:bg-gray-50">
                                                <td className="p-2 font-semibold">{subject.subject_id}</td>
                                                <td className="p-2 text-center">
                                                    {subject.independence_index ? parseFloat(subject.independence_index).toFixed(2) : '-'}
                                                </td>
                                                <td className="p-2 text-center">
                                                    {subject.steps_sum ? parseInt(subject.steps_sum).toLocaleString() : '-'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Device Quality & Notifications */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Device Quality */}
                        <div className="card-glass rounded-2xl p-6 shadow-xl">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">üì± ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</h2>
                            
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div className="bg-blue-500 text-white p-4 rounded-lg text-center">
                                    <div className="text-2xl font-bold">{data.deviceSummary?.total_devices || 0}</div>
                                    <div className="text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                </div>
                                <div className="bg-green-500 text-white p-4 rounded-lg text-center">
                                    <div className="text-2xl font-bold">{data.deviceSummary?.active_devices || 0}</div>
                                    <div className="text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div>
                                </div>
                            </div>

                            <div className="max-h-32 overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th className="p-2 text-left">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                                            <th className="p-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.deviceQuality.slice(0, 5).map((device, index) => (
                                            <tr key={index} className="border-b">
                                                <td className="p-2 text-xs">{device.device_id || device.sensor_file}</td>
                                                <td className="p-2 text-center">{parseInt(device.row_count || 0).toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Notifications */}
                        <div className="card-glass rounded-2xl p-6 shadow-xl">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
                            
                            <div className="space-y-3">
                                {notifications.length === 0 ? (
                                    <div className="text-center text-gray-500 py-8">
                                        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
                                    </div>
                                ) : (
                                    notifications.map((notification) => (
                                        <div 
                                            key={notification.id}
                                            className={`p-3 rounded-lg text-sm ${
                                                notification.type === 'error' ? 'bg-red-100 text-red-800' :
                                                notification.type === 'success' ? 'bg-green-100 text-green-800' :
                                                'bg-blue-100 text-blue-800'
                                            }`}
                                        >
                                            <div className="font-semibold">{notification.message}</div>
                                            <div className="text-xs mt-1 opacity-75">
                                                {notification.timestamp.toLocaleTimeString('th-TH')}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>

                            {/* Action Buttons */}
                            <div className="mt-4 space-y-2">
                                <button 
                                    onClick={() => addNotification('üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', 'info') || fetchData()}
                                    className="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg text-sm font-semibold"
                                >
                                    üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                                <button 
                                    onClick={() => addNotification('üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success')}
                                    className="w-full bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-lg text-sm font-semibold"
                                >
                                    üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Loading Overlay */}
                    {data.loading && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="card-glass p-8 rounded-2xl text-center">
                                <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                <div className="text-xl font-semibold text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>