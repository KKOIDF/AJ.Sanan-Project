<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ - Eldercare System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans Thai', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .risk-low { background: #10b981; }
        .risk-medium { background: #f59e0b; }
        .risk-high { background: #ef4444; }
        
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function useRoute() {
            const [path, setPath] = useState(window.location.pathname);
            useEffect(() => {
                const onPop = () => setPath(window.location.pathname);
                window.addEventListener('popstate', onPop);
                return () => window.removeEventListener('popstate', onPop);
            }, []);
            const navigate = (to) => { window.history.pushState({}, '', to); setPath(to); };
            return { path, navigate };
        }

        function Nav({ navigate }) {
            return (
                <div className="card-glass rounded-2xl p-4 mb-4 flex flex-wrap items-center gap-3">
                    <button className="px-4 py-2 bg-white rounded-lg shadow" onClick={() => navigate('/')}>üè† Home</button>
                    <button className="px-4 py-2 bg-white rounded-lg shadow" onClick={() => navigate('/alerts')}>üîî Alerts</button>
                    <button className="px-4 py-2 bg-white rounded-lg shadow" onClick={() => navigate('/people')}>üë• People</button>
                </div>
            );
        }

        function Home() {
            const [data, setData] = useState({
                subjects: [], riskLevels: [], riskCounts: {}, deviceQuality: [], deviceSummary: {}, loading: true, currentTime: new Date()
            });
            const [notifications, setNotifications] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const addNotification = (message, type) => {
                const id = Date.now();
                const notification = { id, message, type, timestamp: new Date() };
                setNotifications(prev => [notification, ...prev.slice(0,4)]);
                setTimeout(()=> setNotifications(prev => prev.filter(n=>n.id!==id)), 5000);
            };
            const fetchData = async () => {
                try {
                    const [subjectsRes, riskRes, deviceRes] = await Promise.all([
                        fetch('/api/subjects?limit=50'),
                        fetch('/api/risk-levels?method=quantile'),
                        fetch('/api/device-quality')
                    ]);
                    const subjects = await subjectsRes.json();
                    const riskLevels = await riskRes.json();
                    const deviceQuality = await deviceRes.json();
                    setData(prev => ({
                        ...prev,
                        subjects: subjects.subjects || [],
                        riskLevels: riskLevels.risk_levels || [],
                        riskCounts: riskLevels.counts || {},
                        riskMeta: riskLevels.meta || {},
                        deviceQuality: deviceQuality.devices || [],
                        deviceSummary: deviceQuality.summary || {},
                        loading: false
                    }));
                    addNotification('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } catch (e) {
                    console.error(e); addNotification('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','error'); setData(p=>({...p,loading:false}));
                }
            };
            useEffect(()=>{ fetchData(); const t=setInterval(()=> setData(p=>({...p,currentTime:new Date()})),1000); return ()=>clearInterval(t); },[]);
            const handleEmergency = ()=> addNotification('üö® ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô!','error');
            const handleOkStatus = ()=> addNotification('‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ OK ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','success');
            const handleCallCaregiver = ()=> { addNotification('üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•...','info'); setTimeout(()=> addNotification('‚úÖ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success'),2000); };
            const filteredSubjects = data.subjects.filter(s => !searchTerm || s.subject_id?.toLowerCase().includes(searchTerm.toLowerCase()));
            return (
                <div>
                    <div className="card-glass rounded-2xl p-6 mb-6 shadow-xl">
                        <div className="text-center">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</h1>
                            <p className="text-gray-600 mb-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö: <span className="text-green-600 font-semibold">‚úÖ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span><span className="ml-4">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: {data.currentTime.toLocaleString('th-TH')}</span></p>
                            <div className="flex flex-wrap justify-center gap-4">
                                <button onClick={handleOkStatus} className="btn-primary text-white px-8 py-4 rounded-full text-lg font-semibold hover:scale-105 transition-transform">‚úÖ ‡∏â‡∏±‡∏ô‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ</button>
                                <button onClick={handleCallCaregiver} className="bg-orange-500 hover:bg-orange-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:scale-105 transition-transform">üìû ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</button>
                                <button onClick={handleEmergency} className="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:scale-105 transition-transform animate-pulse">üö® ‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô!</button>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div className="card-glass rounded-2xl p-6 shadow-xl">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">üìä ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h2>
                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <div className="risk-low text-white p-4 rounded-lg text-center"><div className="text-2xl font-bold">{data.riskCounts?.Low || 0}</div><div className="text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥</div></div>
                                <div className="risk-medium text-white p-4 rounded-lg text-center"><div className="text-2xl font-bold">{data.riskCounts?.Medium || 0}</div><div className="text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</div></div>
                                <div className="risk-high text-white p-4 rounded-lg text-center"><div className="text-2xl font-bold">{data.riskCounts?.High || 0}</div><div className="text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</div></div>
                            </div>
                            <div className="max-h-64 overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100 sticky top-0"><tr><th className="p-2 text-left">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th><th className="p-2 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th className="p-2 text-center">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th></tr></thead>
                                    <tbody>
                                        {data.riskLevels.slice(0,10).map((item,i)=>(
                                            <tr key={i} className="border-b hover:bg-gray-50">
                                                <td className="p-2 font-semibold">{item.subject_id}</td>
                                                <td className="p-2 text-center">{parseFloat(item.independence_index).toFixed(2)}</td>
                                                <td className="p-2 text-center"><span className={`px-3 py-1 rounded-full text-white text-xs font-semibold ${item.risk_level==='Low'?'risk-low':item.risk_level==='Medium'?'risk-medium':'risk-high'}`}>{item.risk_level==='Low'?'‡∏ï‡πà‡∏≥':item.risk_level==='Medium'?'‡∏Å‡∏•‡∏≤‡∏á':'‡∏™‡∏π‡∏á'}</span></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="card-glass rounded-2xl p-6 shadow-xl">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
                            <div className="mb-4"><input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..." className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                            <div className="max-h-64 overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100 sticky top-0"><tr><th className="p-2 text-left">‡∏£‡∏´‡∏±‡∏™</th><th className="p-2 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞</th><th className="p-2 text-center">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô</th></tr></thead>
                                    <tbody>
                                        {filteredSubjects.slice(0,15).map((s,i)=>(
                                            <tr key={i} className="border-b hover:bg-gray-50">
                                                <td className="p-2 font-semibold">{s.subject_id}</td>
                                                <td className="p-2 text-center">{s.independence_index?parseFloat(s.independence_index).toFixed(2):'-'}</td>
                                                <td className="p-2 text-center">{s.steps_sum?parseInt(s.steps_sum).toLocaleString():'-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="card-glass rounded-2xl p-6 shadow-xl">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">üì± ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå</h2>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div className="bg-blue-500 text-white p-4 rounded-lg text-center"><div className="text-2xl font-bold">{data.deviceSummary?.total_devices||0}</div><div className="text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                                <div className="bg-green-500 text-white p-4 rounded-lg text-center"><div className="text-2xl font-bold">{data.deviceSummary?.active_devices||0}</div><div className="text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div></div>
                            </div>
                            <div className="max-h-32 overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100 sticky top-0"><tr><th className="p-2 text-left">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th className="p-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th></tr></thead>
                                    <tbody>
                                        {data.deviceQuality.slice(0,5).map((d,i)=>(
                                            <tr key={i} className="border-b"><td className="p-2 text-xs">{d.device_id||d.sensor_file}</td><td className="p-2 text-center">{parseInt(d.row_count||0).toLocaleString()}</td></tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="card-glass rounded-2xl p-6 shadow-xl">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ Home)</h2>
                            <div className="space-y-3">
                                {notifications.length===0? <div className="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div> : notifications.map(n=>(
                                    <div key={n.id} className={`p-3 rounded-lg text-sm ${n.type==='error'?'bg-red-100 text-red-800':n.type==='success'?'bg-green-100 text-green-800':'bg-blue-100 text-blue-800'}`}> <div className="font-semibold">{n.message}</div><div className="text-xs mt-1 opacity-75">{n.timestamp.toLocaleTimeString('th-TH')}</div></div>
                                ))}
                            </div>
                            <div className="mt-4 space-y-2">
                                <button onClick={()=> addNotification('üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...','info') || fetchData()} className="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg text-sm font-semibold">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                                <button onClick={()=> addNotification('üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success')} className="w-full bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-lg text-sm font-semibold">üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                            </div>
                        </div>
                    </div>
                    {data.loading && <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div className="card-glass p-8 rounded-2xl text-center"><div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div><div className="text-xl font-semibold text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div></div>}
                </div>
            );
        }

        function AlertsView() {
            const [loading,setLoading]=useState(true); const [items,setItems]=useState([]);
            const load=async()=>{ setLoading(true); const res=await fetch('/api/alerts'); const json=await res.json(); setItems(json.alerts||[]); setLoading(false); };
            useEffect(()=>{ load(); },[]);
            const act=async(id,action)=>{ await fetch(`/api/alerts/${id}/${action}`,{method:'POST'}); load(); };
            return <div className="p-4"><div className="card-glass rounded-2xl p-6 shadow-xl"><h2 className="text-2xl font-bold text-gray-800 mb-4">üîî Alerts Center</h2>{loading? <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>: <div className="max-h-[60vh] overflow-y-auto"><table className="w-full text-sm"><thead className="bg-gray-100 sticky top-0"><tr><th className="p-2 text-left">ID</th><th className="p-2">Subject</th><th className="p-2">Type</th><th className="p-2">Severity</th><th className="p-2">Status</th><th className="p-2">Created</th><th className="p-2">Actions</th></tr></thead><tbody>{items.map(a=> <tr key={a.id} className="border-b hover:bg-gray-50"><td className="p-2">{a.id}</td><td className="p-2 font-semibold">{a.subject_id}</td><td className="p-2">{a.type}</td><td className="p-2">{a.severity}</td><td className="p-2">{a.status}</td><td className="p-2 text-xs">{a.createdAt}</td><td className="p-2 space-x-2"><button className="px-3 py-1 bg-green-500 text-white rounded" onClick={()=>act(a.id,'ack')}>Ack</button><button className="px-3 py-1 bg-red-500 text-white rounded" onClick={()=>act(a.id,'decline')}>Decline</button></td></tr>)}</tbody></table></div>}</div></div>;
        }

        function PeopleList({ navigate }) {
            const [loading,setLoading]=useState(true); 
            const [roster,setRoster]=useState([]); // pure IDs
            const [meta,setMeta]=useState({}); // map id -> metadata from /api/people
            const [error,setError]=useState(null);
            const [search,setSearch]=useState('');

            useEffect(()=>{ 
                (async()=>{ 
                    try {
                        const [idsRes, peopleRes] = await Promise.all([
                            fetch('/api/people/ids'),
                            fetch('/api/people')
                        ]);
                        const idsJson = await idsRes.json();
                        const peopleJson = await peopleRes.json();
                        setRoster(idsJson.ids || []);
                        const map = {};
                        (peopleJson.people||[]).forEach(p=>{ map[p.subject_id]=p; });
                        setMeta(map);
                    } catch(e){ setError(e.message); }
                    setLoading(false);
                })();
            },[]);

            const filtered = roster.filter(id => !search || id.toLowerCase().includes(search.toLowerCase()));

            const exportCSV = async ()=>{
                // ensure latest roster (optional re-fetch)
                try {
                    const r = await fetch('/api/people/ids');
                    const j = await r.json();
                    const ids = j.ids || roster;
                    const header = 'subject_id';
                    const rows = ids.map(id=>id);
                    const csvContent = [header, ...rows].join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `subject_roster_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                } catch(e){ alert('Export failed: '+e.message); }
            };

            return <div className="p-4">
                <div className="card-glass rounded-2xl p-6 shadow-xl">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Roster)</h2>
                    <div className="flex flex-wrap gap-2 mb-4">
                        <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ subject_id..." className="flex-1 min-w-[200px] p-2 border rounded" />
                        <button onClick={exportCSV} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-semibold">‚¨áÔ∏è Export CSV</button>
                        <div className="text-sm text-gray-600 self-center">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {roster.length} | ‡πÅ‡∏™‡∏î‡∏á: {filtered.length}</div>
                    </div>
                    {loading && <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>}
                    {error && <div className="text-red-600 text-sm">‚ùå {error}</div>}
                    {!loading && !error && <div className="max-h-[60vh] overflow-y-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-100 sticky top-0">
                                <tr>
                                    <th className="p-2 text-left">Subject</th>
                                    <th className="p-2 text-center">Risk</th>
                                    <th className="p-2 text-center">Index</th>
                                    <th className="p-2 text-center">Steps</th>
                                    <th className="p-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filtered.map(id => {
                                    const m = meta[id] || {};
                                    return <tr key={id} className="border-b hover:bg-gray-50">
                                        <td className="p-2 font-semibold">{id}</td>
                                        <td className="p-2 text-center">{m.risk_level||'-'}</td>
                                        <td className="p-2 text-center">{m.independence_index!=null?Number(m.independence_index).toFixed(2):'-'}</td>
                                        <td className="p-2 text-center">{m.steps_sum!=null?Number(m.steps_sum).toLocaleString():'-'}</td>
                                        <td className="p-2 text-center"><button className="px-3 py-1 bg-blue-500 text-white rounded" onClick={()=>navigate(`/people/${id}`)}>‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</button></td>
                                    </tr>;
                                })}
                                {filtered.length===0 && <tr><td colSpan={5} className="p-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>}
                            </tbody>
                        </table>
                    </div>}
                </div>
            </div>;
        }

        function PersonDetail({ id }) {
            const [loading,setLoading]=useState(true); 
            const [detail,setDetail]=useState(null);
            const [showRaw,setShowRaw]=useState(false);
            const [raw,setRaw]=useState({loading:false,data:null,error:null,limit:100});

            useEffect(()=>{ 
                (async()=>{ 
                    setLoading(true);
                    const r=await fetch(`/api/people/${id}`); 
                    if(r.ok){ setDetail(await r.json()); }
                    setLoading(false); 
                })(); 
            },[id]);

            // load raw records when toggled on or limit changes
            useEffect(()=>{ 
                if(showRaw){ loadRaw(raw.limit); }
                // eslint-disable-next-line react-hooks/exhaustive-deps
            },[showRaw, id]);

            const loadRaw = async (limit)=>{
                setRaw(p=>({...p,loading:true,error:null}));
                try {
                    const r = await fetch(`/api/people/${id}/records?limit=${limit}`);
                    if(!r.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    const j = await r.json();
                    setRaw({loading:false,data:j,error:null,limit});
                } catch(e){
                    console.error(e);
                    setRaw(p=>({...p,loading:false,error:e.message}));
                }
            };

            const changeLimit=(e)=>{
                const v = parseInt(e.target.value)||50;
                setRaw(p=>({...p,limit:v}));
                loadRaw(v);
            };

            if(loading) return <div className="p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>; 
            if(!detail) return <div className="p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>;

            return <div className="p-4">
                <div className="card-glass rounded-2xl p-6 shadow-xl mb-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">üßë ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {detail.subject_id}</h2>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div className="p-3 bg-white rounded-lg shadow"><div className="text-sm text-gray-500">Risk</div><div className="text-xl font-semibold">{detail.metrics?.risk_level||'-'}</div></div>
                        <div className="p-3 bg-white rounded-lg shadow"><div className="text-sm text-gray-500">Independence Index</div><div className="text-xl font-semibold">{detail.metrics?.independence_index!=null?Number(detail.metrics.independence_index).toFixed(2):'-'}</div></div>
                        <div className="p-3 bg-white rounded-lg shadow"><div className="text-sm text-gray-500">Active Minutes</div><div className="text-xl font-semibold">{detail.metrics?.active_minutes!=null?Number(detail.metrics.active_minutes).toLocaleString():'-'}</div></div>
                        <div className="p-3 bg-white rounded-lg shadow"><div className="text-sm text-gray-500">Steps (Sum)</div><div className="text-xl font-semibold">{detail.metrics?.steps_sum!=null?Number(detail.metrics.steps_sum).toLocaleString():'-'}</div></div>
                    </div>
                    <div className="p-3 bg-white rounded-lg shadow mb-4">
                        <div className="text-sm text-gray-500">QC Window</div>
                        <div className="text-sm">{detail.qc?.min_date||'-'} ‚Üí {detail.qc?.max_date||'-'}</div>
                        <div className="text-xs mt-1 text-gray-500">Records: {detail.qc?.records!=null?detail.qc.records:'-'}, Unique Days: {detail.qc?.unique_days!=null?detail.qc.unique_days:'-'}</div>
                    </div>
                    <div className="flex flex-wrap gap-2">
                        <button onClick={()=> setShowRaw(s=>!s)} className="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">{showRaw? 'üîΩ ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö':'üìÑ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö'}</button>
                        {showRaw && <>
                            <label className="text-sm text-gray-700 flex items-center gap-1">‡πÅ‡∏™‡∏î‡∏á <select value={raw.limit} onChange={changeLimit} className="border rounded px-2 py-1 text-sm"><option value={50}>50</option><option value={100}>100</option><option value={200}>200</option><option value={500}>500</option></select> ‡πÅ‡∏ñ‡∏ß</label>
                            <button onClick={()=> loadRaw(raw.limit)} className="px-3 py-2 rounded bg-purple-500 hover:bg-purple-600 text-white text-sm">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö</button>
                            {raw.data && raw.data.total>raw.limit && <div className="text-xs text-gray-600 self-center">(‡πÅ‡∏™‡∏î‡∏á {raw.limit} ‡∏à‡∏≤‡∏Å {raw.data.total} ‡πÅ‡∏ñ‡∏ß ‚Äì ‡πÄ‡∏û‡∏¥‡πà‡∏° limit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)</div>}
                        </>}
                    </div>
                </div>
                {showRaw && <div className="card-glass rounded-2xl p-4 shadow-xl">
                    <h3 className="text-xl font-bold text-gray-800 mb-3">üìÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Raw Records)</h3>
                    {raw.loading && <div className="p-4 text-sm text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö...</div>}
                    {raw.error && <div className="p-4 text-sm text-red-600">‚ùå {raw.error}</div>}
                    {(!raw.loading && raw.data) && <div className="overflow-auto max-h-[65vh] border rounded bg-white">
                        <table className="text-xs min-w-full">
                            <thead className="bg-gray-100 sticky top-0">
                                <tr>{raw.data.columns.map(c=> <th key={c} className="p-2 text-left whitespace-nowrap">{c}</th>)}</tr>
                            </thead>
                            <tbody>
                                {raw.data.records.map((row,i)=> <tr key={i} className="border-b hover:bg-gray-50">{row.map((cell,j)=> <td key={j} className="p-1 whitespace-nowrap">{cell===null||cell===undefined?'-':String(cell)}</td>)}</tr>)}
                                {raw.data.records.length===0 && <tr><td className="p-4 text-center text-gray-500" colSpan={raw.data.columns.length}>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>}
                            </tbody>
                        </table>
                    </div>}
                </div>}
            </div>;
        }

        function App(){
            const { path, navigate } = useRoute();
            const match = path.match(/^\/people\/(.+)$/);
            return <div className="min-h-screen p-4"><Nav navigate={navigate} />{path==='/' && <Home />}{path==='/alerts' && <AlertsView />}{path==='/people' && <PeopleList navigate={navigate} />}{match && <PersonDetail id={match[1]} />}</div>;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>